<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Detector — Calibrated & Explainable</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --accent:#1e40af; --muted:#6b7280;
    --weak:#fff8dc; --med:#ffeed8; --strong:#ffe5ec;
    --danger:#cc0000;
  }
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--bg); color:#0b1230;}
  .wrap{max-width:1150px; margin:26px auto; padding:20px;}
  h1{margin:0 0 6px; font-size:20px;}
  .lead{color:var(--muted); margin:8px 0 18px;}
  .grid{display:grid; grid-template-columns:1fr 420px; gap:18px;}
  .card{background:var(--card); border-radius:10px; padding:14px; box-shadow:0 6px 20px rgba(13, 30, 60, 0.05);}
  textarea{width:100%; min-height:420px; padding:12px; border-radius:8px; border:1px solid #e6eef8; font-size:14px; line-height:1.6; resize:vertical; background:transparent;}
  .controls{display:flex; gap:8px; align-items:center; margin-bottom:10px;}
  button{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#eef2ff; color:var(--accent); border:1px solid #dbeafe;}
  .small{font-size:13px;color:var(--muted);}
  .gauge{display:flex; align-items:center; gap:12px;}
  .bars{margin-top:10px;}
  .bar{display:flex; gap:10px; align-items:center; margin:8px 0;}
  .bar .meta{width:180px; font-size:13px; color:var(--muted);}
  .bar .meter{flex:1; height:12px; background:#f1f5f9; border-radius:999px; overflow:hidden;}
  .bar .meter > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),#60a5fa); width:0%;}
  .bar .score{width:44px; text-align:right; font-weight:700;}
  .highlights{margin-top:12px; padding:12px; border-radius:8px; border:1px dashed #e6eef8; background:#fff;}
  .match{background:var(--weak); border-radius:3px; padding:0 2px; cursor:help;}
  .match.med{background:var(--med);}
  .match.strong{background:var(--strong);}
  .explain{font-size:13px;color:var(--muted); margin-top:8px;}
  .diag{padding:12px;border-radius:8px;margin-top:10px}
  .diag.emdash{background:#ffecef;border:2px solid var(--danger); box-shadow:0 4px 12px rgba(204,0,0,0.06)}
  .diag.default{background:#fffaf0;border:1px solid #ffd6a5}
  .footer{margin-top:12px; font-size:13px; color:var(--muted);}
  .tog {display:flex; align-items:center; gap:8px; margin-top:8px;}
  .log-controls{display:flex; gap:8px; margin-top:8px; align-items:center;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .gauge{margin-top:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>AI Detector — Calibrated & Explainable</h1>
    <div class="lead">this would like to store stuff here <code>referenceLibrary.js</code> for data collection for improvement</div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <button id="analyzeBtn">Analyze</button>
          <button class="secondary" id="clearBtn">Clear</button>
          <button id="downloadLogBtn" class="secondary">Download Log</button>
          <button id="exportPdfBtn" style="margin-left:auto;background:#0ea5a4">Export PDF</button>
        </div>

        <textarea id="inputText" placeholder="Paste text here..."></textarea>

        <div class="explain">
          <details open>
            <summary><strong>How we calculate AI scores</strong></summary>
            <div style="margin-top:8px">
              <div><strong>Plain language:</strong> each category has a weight. We compute a local score for each category, and then combine only the categories that appear in the text into a weighted average. basically its like a google sheets formula so nothing really special but we use fancy stuff to do it.</div>
              <div style="margin-top:6px"><strong>Formula:</strong> <code>AI = sum_{s_i>0}(w_i * s_i) / sum_{s_i>0}(w_i)</code></div>
            </div>
          </details>

          <div class="tog">
            <label><input type="checkbox" id="backendToggle"> Save to backend (do it good idea)</label>
            <input id="backendUrl" placeholder="Backend endpoint URL (optional)" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e6eef8" value="https://your-api-endpoint.example.com/log"/>
          </div>

          <div class="log-controls">
            <button id="clearLocalBtn" class="secondary">Clear Local Log</button>
            <div class="small">Local log stored in browser; exportable via Download Log.</div>
          </div>
        </div>

        <div class="highlights">
          <div style="font-weight:700;margin-bottom:8px">Highlighted text (matches shown inline)</div>
          <div id="renderedText" style="white-space:pre-wrap; font-size:15px; line-height:1.6;"></div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700">Analysis</div>
          <div class="small">Weighted average across triggered categories</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:12px; align-items:center;">
          <div class="gauge">
            <svg width="110" height="110" viewBox="0 0 120 120">
              <defs><linearGradient id="g1" x1="0%" x2="100%"><stop offset="0%" stop-color="#1e40af"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs>
              <circle cx="60" cy="60" r="46" stroke="#eef2f6" stroke-width="14" fill="none"></circle>
              <circle id="gaugeArc" cx="60" cy="60" r="46" stroke="url(#g1)" stroke-width="14" stroke-linecap="round" stroke-dasharray="290" stroke-dashoffset="290" fill="none"></circle>
            </svg>
            <div style="display:flex; flex-direction:column; align-items:center;">
              <div id="overallPct" style="font-weight:800; font-size:20px">0%</div>
              <div class="small">AI likelihood</div>
            </div>
          </div>

          <div style="flex:1">
            <div id="summaryHeadline" style="font-weight:700">No analysis yet</div>
            <div id="summaryText" class="small">Click Analyze to get results.</div>
            <div id="rulesList" style="margin-top:12px; max-height:380px; overflow:auto;"></div>
          </div>
        </div>

        <div class="bars" id="barsWrap"></div>

        <div id="diagWrap"></div>

        <div class="footer">This is a heuristic tool intended for investigation and research. Matches are suggestive, not definitive.</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:700;margin-bottom:8px">Sample essay (preloaded)</div>
      <div class="small">Your climate-change essay has been preloaded into the editor for testing.</div>
    </div>
  </div>

<!-- html2canvas and jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* Robust AI detector front-end.
   - Tries to load referenceLibrary.js if present (via dynamic script tag) and falls back to embedded defaults on timeout.
   - Fixed duplicate functions, consistent variable names, and cleaned logic.
*/

// ---------- Embedded fallback reference library ----------
const FALLBACK_REFERENCE = {
  baseWeights: {
    emDash: 1.7, promo: 1.6, symbolism: 1.5, weasel: 1.3, templating: 1.4,
    disclaimer:1.1, genericSummary:1.0, phenomenon:1.2, weirdQuotes:0.5, longLists:0.8,
    hedging:0.9, citationTokens:1.3, sectionCase:0.6, emphasisSignposting:1.0,
    technicalPhrases:1.1, conjunctiveIng:0.7, overcitation:1.1, lists:0.6
  },
  stats: {
    emDash: {aiAvg:5.8, humanAvg:1.1}, promo:{aiAvg:9.2, humanAvg:2.4},
    symbolism:{aiAvg:4.0, humanAvg:1.5}, weasel:{aiAvg:3.6, humanAvg:1.4},
    templating:{aiAvg:1.9, humanAvg:0.1}, disclaimer:{aiAvg:2.2, humanAvg:0.4},
    genericSummary:{aiAvg:6.0, humanAvg:2.3}, phenomenon:{aiAvg:4.8, humanAvg:1.8},
    weirdQuotes:{aiAvg:1.1, humanAvg:0.8}, longLists:{aiAvg:6.5, humanAvg:3.2},
    hedging:{aiAvg:7.4, humanAvg:4.0}, citationTokens:{aiAvg:2.8, humanAvg:0.6},
    sectionCase:{aiAvg:3.0, humanAvg:2.6}, emphasisSignposting:{aiAvg:5.5, humanAvg:2.0},
    technicalPhrases:{aiAvg:4.2, humanAvg:3.1}, conjunctiveIng:{aiAvg:6.2, humanAvg:3.9},
    overcitation:{aiAvg:3.2, humanAvg:1.7}, lists:{aiAvg:5.0, humanAvg:2.9}
  },
  note: "Fallback embedded calibration. Optional external referenceLibrary.js can override this."
};

let REFERENCE = FALLBACK_REFERENCE; // will be replaced if external loaded

// Attempt to load external referenceLibrary.js (non-blocking, but wait up to timeout)
function loadReferenceLibrary(timeoutMs = 600) {
  return new Promise((resolve) => {
    if (window.REFERENCE_LIBRARY) {
      REFERENCE = window.REFERENCE_LIBRARY;
      resolve(true);
      return;
    }
    // Try to inject a script tag — user may have dropped referenceLibrary.js in same folder
    const script = document.createElement('script');
    script.src = './referenceLibrary.js';
    script.async = true;
    let settled = false;
    script.onload = () => {
      if (window.REFERENCE_LIBRARY) REFERENCE = window.REFERENCE_LIBRARY;
      settled = true;
      resolve(true);
    };
    script.onerror = () => {
      settled = true;
      resolve(false);
    };
    document.head.appendChild(script);
    // timeout fallback
    setTimeout(() => {
      if (!settled) resolve(false);
    }, timeoutMs);
  });
}

// ---------- RULES ----------
const RULES = [
  { id:'emDash', label:'Em-dash overuse', weightKey:'emDash', patterns:["—{1,}"], strongIf:1,
    description:"Frequent em dashes indicate long, clause-heavy sentences and clause-chaining typical of many generated essays; this is a high-reliability signal." },

  { id:'promo', label:'Promotional / grandeur language', weightKey:'promo',
    patterns:["\\b(revolutionary|groundbreaking|stunning|thriving|boasts a|rich tapestry|remarkable journeys?)\\b","\\b(remarkable|extraordinary|unprecedented|profoundly)\\b"],
    strongIf:1, description:"Generalized hyperbole and promotional adjectives that replace specific detail." },

  { id:'symbolism', label:'Symbolic / "serves as" phrasing', weightKey:'symbolism', patterns:["\\b(serves as a testament|serves as a reminder|stands as a testament|stands as)\\b"], strongIf:1,
    description:"Excessive symbolism and rhetorical signposting." },

  { id:'weasel', label:'Vague attributions / weasel words', weightKey:'weasel', patterns:["\\b(experts say|some critics argue|observers have noted|studies suggest|research indicates|it is argued|observers note)\\b"], strongIf:1,
    description:"Attributions without concrete sources." },

  { id:'templating', label:'Template placeholders', weightKey:'templating', patterns:["\\[.*?\\]","\\{\\{.*?\\}\\}","Enter\\s+\\w+"], strongIf:1,
    description:"Leftover template tokens or bracketed placeholders." },

  { id:'disclaimer', label:'Didactic disclaimers / model-style phrases', weightKey:'disclaimer', patterns:["as an AI language model","as a large language model","I\\'?m sorry,? I can\\'?t"], strongIf:1,
    description:"Model-style meta statements or disclaimers." },

  { id:'genericSummary', label:'Formulaic conclusions or summaries', weightKey:'genericSummary', patterns:["\\b(in conclusion|in summary|to summarize|ultimately|what was once)\\b"], strongIf:1,
    description:"Section endings and formulaic summary phrasing." },

  { id:'phenomenon', label:'Sweeping cause-effect phrasing', weightKey:'phenomenon', patterns:["\\b(is profoundly altering|is reshaping|is reshaping the availability|profoundly altering)\\b"], strongIf:1,
    description:"Broad-scope claims and sweeping causal language." },

  { id:'weirdQuotes', label:'Smart/curly quotes', weightKey:'weirdQuotes', patterns:["[\\u201c\\u201d\\u2018\\u2019]"], strongIf:2,
    description:"Smart quotes and typographic artifacts from formatted output." },

  { id:'longLists', label:'Rule-of-three / triads', weightKey:'longLists', patterns:["\\b(\\w+[, ]+\\w+[, ]+and\\s+\\w+)\\b"], strongIf:3,
    description:"'A, B, and C' list constructions common in polished generated prose." },

  { id:'hedging', label:'Hedging words', weightKey:'hedging', patterns:["\\b(may|might|could|likely|approximately|arguably)\\b"], strongIf:2,
    description:"Excessive hedging and approximations." },

  { id:'citationTokens', label:'Citation-like tokens / placeholders', weightKey:'citationTokens', patterns:["doi=10\\.", "pmid=\\d{1,7}", "access-date=\\d{4}-xx-xx", "2025-xx-xx"], strongIf:1,
    description:"Citation tokens and placeholder dates." },

  { id:'sectionCase', label:'Title-case section headings', weightKey:'sectionCase', patterns:["\\b([A-Z][a-z]+(?:\\s+[A-Z][a-z]+){1,5})\\b"], strongIf:3,
    description:"Title-case sequences that may indicate auto-generated headings." },

  { id:'emphasisSignposting', label:'Signposting / didactic phrases', weightKey:'emphasisSignposting', patterns:["\\b(it is important to note|it is crucial to note|importantly|it is worth noting)\\b"], strongIf:1,
    description:"Didactic signposting." },

  { id:'technicalPhrases', label:'Scientific-sounding terms', weightKey:'technicalPhrases', patterns:["\\b(phenological mismatch|photoperiod|breeding grounds|migration timing|stopover points)\\b"], strongIf:1,
    description:"Scientific terminology that may be used generically." },

  { id:'conjunctiveIng', label:'-ing connectors / present participles', weightKey:'conjunctiveIng', patterns:["\\b(ensuring|highlighting|underscoring|contributing to|resulting in|leading to)\\b"], strongIf:2,
    description:"Frequent '-ing' connector phrases." },

  { id:'overcitation', label:'Neat parenthetical species/examples', weightKey:'overcitation', patterns:["\\b\\(Ficedula hypoleuca\\)|\\b\\(Tachycineta bicolor\\)|\\b\\(Turdus migratorius\\)","\\b(e\\.g\\.|for example|such as the)\\b"], strongIf:1,
    description:"Precise parenthetical examples without explicit sourcing." },

  { id:'lists', label:'Inline list headers', weightKey:'lists', patterns:["^\\d+\\.\\s+[^\\n]+:\\s","^\\-\\s+[^\\n]+:\\s","^•\\s+[^\\n]+:\\s"], strongIf:1,
    description:"Header-like list items." }
];

// compile regexes
RULES.forEach(r => {
  r.re = r.patterns.map(p => {
    try { return new RegExp(p, 'gmi'); }
    catch(e) { return new RegExp(escapeRegExp(p), 'gmi'); }
  });
});

// ---------- UI references ----------
const inputEl = document.getElementById('inputText');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadLogBtn = document.getElementById('downloadLogBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const clearLocalBtn = document.getElementById('clearLocalBtn');
const backendToggle = document.getElementById('backendToggle');
const backendUrlInput = document.getElementById('backendUrl');

const renderedText = document.getElementById('renderedText');
const barsWrap = document.getElementById('barsWrap');
const overallPctEl = document.getElementById('overallPct');
const gaugeArc = document.getElementById('gaugeArc');
const summaryHeadline = document.getElementById('summaryHeadline');
const summaryText = document.getElementById('summaryText');
const rulesList = document.getElementById('rulesList');
const diagWrap = document.getElementById('diagWrap');

// preload sample essay
inputEl.value = `The Impact of Climate Change on Bird Migration
Introduction

For centuries, the seasonal migrations of birds have fascinated naturalists and scientists alike. Each year, millions of birds embark on remarkable journeys that span continents and oceans, guided by an intricate interplay of instinct, environmental cues, and evolutionary adaptation. Migration serves as a crucial mechanism that allows birds to exploit varying ecological conditions—breeding in temperate regions during summer and retreating to warmer climates during winter. This ancient rhythm of movement has been finely balanced for millennia. However, in the modern age, this delicate equilibrium faces unprecedented disruption. Climate change—an all-encompassing transformation of global weather patterns driven largely by human activity—is profoundly altering the world’s ecosystems. Among its many consequences, the impact on avian migration stands out as both scientifically significant and ecologically alarming.

As global temperatures rise, precipitation patterns shift, and ecosystems are restructured, migratory birds face increasing challenges in timing, navigation, and survival. Changes in climate are reshaping the availability of resources, altering migration routes, and disrupting the synchrony between birds and the seasonal cycles on which they depend. This essay explores the multifaceted impact of climate change on bird migration, focusing on alterations in migration timing, routes, breeding success, and overall population dynamics.

Changing Environmental Cues

Bird migration depends heavily on environmental cues such as temperature, photoperiod (day length), and food availability. These natural signals inform birds when to depart, which direction to travel, and when to return. Yet climate change is distorting these cues, making them increasingly unreliable.

In many regions, spring temperatures are rising earlier than in previous decades. This causes some bird species to begin their migrations prematurely, arriving at breeding grounds before the peak abundance of food resources. In contrast, other species—whose migration timing is more strongly governed by photoperiod—may fail to adjust, arriving too late to take advantage of optimal conditions. This phenomenon, known as a phenological mismatch, can have serious consequences. For example, insectivorous birds such as the pied flycatcher (Ficedula hypoleuca) now often arrive in Europe after the peak of caterpillar abundance, leading to reduced breeding success and population declines.

Furthermore, irregular weather patterns, such as prolonged droughts, heatwaves, and unseasonal storms, can interrupt migration routes. Wetland habitats that once provided critical stopover points for rest and feeding are drying up or shifting geographically. Without these essential refueling stations, many birds struggle to complete their migrations, resulting in increased mortality and weakened populations.

Shifts in Migration Timing and Routes

One of the most well-documented effects of climate change on bird migration is the alteration in migration timing. Long-term studies have shown that numerous species now migrate earlier in the spring and later in the autumn. In North America, for instance, species such as the tree swallow (Tachycineta bicolor) and the American robin (Turdus migratorius) are arriving on their breeding grounds several days or even weeks earlier than they did in the mid-20th century. Similarly, in Europe, the barn swallow (Hirundo rustica) has advanced its spring arrival by over a week in some regions.

In addition to timing shifts, migration routes are also changing. As global temperatures rise, some species are extending their ranges northward into previously unsuitable territories. This expansion, while initially appearing adaptive, can expose birds to new ecological risks—such as unfamiliar predators, competitors, or inadequate nesting conditions. In Arctic and sub-Arctic regions, for example, melting ice and changing vegetation patterns have opened new areas for birds, but these zones are unstable and may not provide consistent resources in the long term.

Moreover, climate-induced habitat loss in tropical and subtropical regions threatens the wintering grounds of countless migratory birds. The shrinking of wetlands in Africa’s Sahel or the deforestation of South American rainforests removes vital habitats, forcing birds to travel further or settle in less suitable areas. The cumulative strain of longer migrations, unpredictable weather, and dwindling resources poses an existential threat to many species.

Ecosystem Mismatches and Breeding Success

A critical consequence of disrupted migration patterns is the growing asynchrony between birds and their ecosystems. Birds have evolved to time their breeding cycles so that their chicks hatch when food is most abundant. However, climate change has altered the timing of insect emergence, plant flowering, and fruiting seasons, decoupling the relationship between birds and their food supply.

For example, in northern Europe, warmer springs have led to earlier insect hatches, but many migratory birds arriving from Africa still follow traditional schedules. The result is that chicks are often raised during periods of food scarcity, leading to higher mortality rates and declining populations. This mismatch not only threatens individual species but can ripple through entire ecosystems. Birds play crucial roles as pollinators, seed dispersers, and pest controllers; thus, their decline can destabilize ecological networks and diminish biodiversity.

In addition, altered climates can affect the breeding success of birds directly. Extreme weather events—such as heatwaves or heavy rainfall—can destroy nests, reduce the availability of nesting materials, and stress adult birds during crucial reproductive stages. High temperatures may also reduce egg viability or chick survival, further exacerbating population declines.

Adaptive Responses and Conservation Challenges

Despite these challenges, some species exhibit a degree of plasticity—the ability to adjust behaviorally or physiologically to changing conditions. Short-distance migrants, which rely more on local environmental cues than long-distance signals, have shown greater capacity to modify their migration schedules. However, long-distance migrants, such as those traveling between continents, are less able to adapt quickly because their movements are tightly controlled by innate genetic programs rather than flexible environmental feedback.

Conservationists are increasingly emphasizing adaptive management strategies to mitigate these threats. Protecting and restoring critical habitats along migration routes, creating wildlife corridors, and monitoring population trends are essential steps. International cooperation is also vital, as migratory birds cross multiple political boundaries during their journeys. Agreements such as the Convention on the Conservation of Migratory Species of Wild Animals (CMS) and regional initiatives like Natura 2000 in Europe aim to provide a coordinated approach to safeguarding migratory species.

Moreover, reducing greenhouse gas emissions remains the most fundamental solution. Unless the rate of climate change is slowed, even the most well-designed conservation measures may not suffice to preserve the complex migratory systems that birds depend upon.

Conclusion

The impact of climate change on bird migration is both profound and far-reaching. It affects not only when and where birds travel but also their survival, reproduction, and ecological roles within their environments. What was once a predictable and harmonious natural cycle is now increasingly erratic, reflecting the instability of the planet’s changing climate.

Bird migration serves as a powerful indicator of environmental health. The disruptions observed among migratory species are not isolated events but symptoms of a broader ecological imbalance. The future of these birds—and the ecosystems they sustain—depends on humanity’s ability to address the root causes of climate change, to conserve vital habitats, and to foster resilience in natural systems.

Ultimately, the story of migrating birds is also the story of the planet itself: interconnected, delicate, and vulnerable to our collective actions. Protecting these travelers of the sky is not merely an act of compassion—it is an imperative step toward preserving the balance of life on Earth.
`;

// ---------- helpers ----------
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// ---------- local log key ----------
const LOG_KEY = 'ai_detector_log_v1';

// ---------- helper: build rules list (show effective weights) ----------
function buildRulesList() {
  const base = (REFERENCE && REFERENCE.baseWeights) ? REFERENCE.baseWeights : {};
  const stats = (REFERENCE && REFERENCE.stats) ? REFERENCE.stats : {};
  let html = '<div class="small"><strong>Rules & effective weights (calibrated)</strong></div>';
  html += '<div style="font-size:13px;margin-top:8px">';
  RULES.forEach(r => {
    const key = r.weightKey;
    const baseW = base[key] !== undefined ? base[key] : 1.0;
    const stat = stats[key] || {aiAvg:1, humanAvg:1};
    const eff = Math.round(baseW * (stat.aiAvg / Math.max(1, stat.humanAvg)) * 100)/100;
    html += `<div style="margin-bottom:6px"><strong>${escapeHtml(r.label)}</strong> — base ${baseW} — effective ${eff}</div>`;
  });
  html += '</div>';
  return html;
}

// ---------- effective weight function ----------
function effectiveWeight(key){
  const baseW = (REFERENCE && REFERENCE.baseWeights && (REFERENCE.baseWeights[key] !== undefined)) ? REFERENCE.baseWeights[key] : 1.0;
  const stat = (REFERENCE && REFERENCE.stats && REFERENCE.stats[key]) ? REFERENCE.stats[key] : {aiAvg:1, humanAvg:1};
  return baseW * (stat.aiAvg / Math.max(1, stat.humanAvg));
}

// ---------- log helpers ----------
function getLocalLog(){ try { const raw = localStorage.getItem(LOG_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function appendLocalLog(entry){ try { const arr = getLocalLog(); arr.push(entry); localStorage.setItem(LOG_KEY, JSON.stringify(arr)); } catch(e){ console.warn('Failed to save local log', e); } }
function clearLocalLogConfirmed(){ if(confirm('Clear local audit log?')){ localStorage.removeItem(LOG_KEY); alert('Local log cleared.'); } }
function downloadLog(){ const arr = getLocalLog(); const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ai_detector_log.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

// ---------- analyze logic ----------
function analyzeText(){
  const text = inputEl.value || '';
  if(!text.trim()){ alert('Please paste some text to analyze.'); return; }

  // find matches
  const allMatches = [];
  const counts = {}; RULES.forEach(r => counts[r.id] = 0);

  RULES.forEach(r => {
    r.re.forEach(regex => {
      regex.lastIndex = 0;
      let m;
      while((m = regex.exec(text)) !== null){
        counts[r.id] += 1;
        allMatches.push({start:m.index, end:m.index + (m[0] ? m[0].length : 1), text:m[0], ruleId:r.id, label:r.label});
        if(m.index === regex.lastIndex) regex.lastIndex++;
      }
    });
  });

  // compute local scores for triggered rules (s_i) and collect only s_i>0
  const perRule = [];
  RULES.forEach(r => {
    const cnt = counts[r.id] || 0;
    const local = Math.min(100, Math.round((cnt / (r.strongIf || 1)) * 25));
    if(local > 0){
      const weightEff = effectiveWeight(r.weightKey);
      perRule.push({ id:r.id, label:r.label, count:cnt, local, weightEff, desc:r.description, key:r.weightKey });
    }
  });

  // compute weighted average ignoring zero categories
  let weightedSum = 0, weightTotal = 0;
  perRule.forEach(p => { weightedSum += p.local * p.weightEff; weightTotal += p.weightEff; });
  const overallPct = weightTotal ? Math.round(weightedSum / weightTotal) : 0;

  // build highlighted HTML avoiding overlapping spans
  allMatches.sort((a,b)=>a.start - b.start || b.end - a.end);
  let pos = 0, out = '';
  for(let i=0;i<allMatches.length;i++){
    const m = allMatches[i];
    if(m.start < pos) continue;
    out += escapeHtml(text.slice(pos, m.start));
    const ruleDef = RULES.find(rr => rr.id === m.ruleId) || {};
    const cntForRule = counts[m.ruleId] || 0;
    const effW = effectiveWeight(ruleDef.weightKey || '');
    let sev = '';
    if(cntForRule >= (ruleDef.strongIf || 1) * 3 || effW >= 1.4) sev = 'strong';
    else if(cntForRule >= (ruleDef.strongIf || 1) * 2 || effW >= 1.1) sev = 'med';
    const cls = `match ${sev}`.trim();
    const title = `${m.label} — matched phrase: "${m.text.replace(/\n/g,' ')}"`;
    out += `<span class="${cls}" title="${escapeHtml(title)}" data-rule="${m.ruleId}">${escapeHtml(m.text)}</span>`;
    pos = m.end;
  }
  out += escapeHtml(text.slice(pos));
  renderedText.innerHTML = out || '(no matches)';

  // render bars
  perRule.sort((a,b)=>b.local - a.local);
  barsWrap.innerHTML = '';
  perRule.forEach(rp => {
    const row = document.createElement('div'); row.className = 'bar';
    row.innerHTML = `<div class="meta">${escapeHtml(rp.label)}</div>
      <div class="meter"><i style="width:${rp.local}%"></i></div>
      <div class="score">${rp.local}%</div>`;
    barsWrap.appendChild(row);
  });

  // update gauge & summary
  overallPctEl.textContent = overallPct + '%';
  const dash = 290 - (290 * (overallPct/100));
  gaugeArc.style.strokeDashoffset = dash;
  summaryHeadline.textContent = overallPct >= 70 ? 'Likely AI-generated (heuristic)' : (overallPct >= 35 ? 'Possibly AI-generated' : 'Likely human-written');
  summaryText.textContent = `Overall AI score: ${overallPct}%. Computed using ${perRule.length} triggered category(ies).`;

  // diagnostics cards
  diagWrap.innerHTML = '';
  perRule.forEach(rp => {
    const card = document.createElement('div');
    card.className = (rp.id === 'emDash') ? 'diag emdash' : 'diag default';
    card.innerHTML = `<div style="font-weight:700">${escapeHtml(rp.label)} — ${rp.local}% (${rp.count} matches)</div>
      <div style="margin-top:8px" class="small">${escapeHtml(rp.desc)}</div>
      <div style="margin-top:8px;font-size:13px;color:#374151">Effective weight: ${rp.weightEff.toFixed(2)} (key: ${rp.key})</div>`;
    diagWrap.appendChild(card);
  });

  // store audit log entry
  const entry = {
    timestamp: new Date().toISOString(),
    overallPct,
    categories: perRule.map(p => ({id:p.id,label:p.label,local:p.local,count:p.count,weightEff:p.weightEff})),
    snippet: inputEl.value.slice(0, 2000)
  };
  appendLocalLog(entry);

  // optional backend post (only with explicit consent)
  if(backendToggle.checked){
    const url = (backendUrlInput.value || '').trim();
    if(url){
      if(confirm('You enabled backend save. This will POST the analysis to the configured endpoint. Proceed?')){
        fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry)})
          .then(res => { if(res.ok) alert('Saved to backend (server responded OK).'); else alert('Server returned status ' + res.status); })
          .catch(err => { alert('Failed to save to backend: ' + (err && err.message ? err.message : err)); });
      }
    } else alert('Please provide a backend URL to send data.');
  }
}

// ---------- PDF export ----------
async function exportPDF(){
  const title = 'ai_detector_report';
  const overall = overallPctEl.textContent || '0%';
  const headline = summaryHeadline.textContent || '';
  const perRuleHtml = Array.from(document.querySelectorAll('.bar')).map(b => b.outerHTML).join('');
  const diagHtml = diagWrap.innerHTML || '';
  const highlighted = renderedText.innerHTML || escapeHtml(inputEl.value || '');

  const reportHtml = `
    <div style="font-family:Arial,Helvetica,sans-serif;padding:24px;color:#101828">
      <h1 style="margin-bottom:6px">AI-detection report</h1>
      <div style="margin-bottom:10px"><strong>Overall AI score:</strong> ${escapeHtml(overall)} — ${escapeHtml(headline)}</div>
      <div style="margin-bottom:12px"><strong>Scoring formula:</strong> AI = sum_{s_i>0}(w_i * s_i) / sum_{s_i>0}(w_i)</div>
      <h3>Per-category scores</h3>
      <div>${perRuleHtml}</div>
      <h3 style="margin-top:12px">Diagnostic explanations</h3>
      <div>${diagHtml}</div>
      <h3 style="margin-top:12px">Highlighted text</h3>
      <div style="padding:12px;border:1px solid #eef2f6;border-radius:8px;background:#fff;white-space:pre-wrap">${highlighted}</div>
      <div style="margin-top:18px;color:#6b7280;font-size:12px">Generated by heuristic detector. This report is not definitive evidence of AI authorship.</div>
    </div>
  `;

  const popup = window.open('', '_blank', 'width=800,height=1000');
  if(!popup){ alert('Popup blocked. Please allow popups for this site.'); return; }
  popup.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Report</title></head><body style="margin:0;padding:0;background:#f6f7fb">${reportHtml}</body></html>`);
  await new Promise(res => setTimeout(res, 400));
  try{
    const canvas = await html2canvas(popup.document.body, {scale:1.4, backgroundColor:null, useCORS:true});
    const imgData = canvas.toDataURL('image/jpeg', 0.94);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
    pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
    pdf.save(title + '.pdf');
  } catch(err){
    alert('Export failed: ' + (err && err.message ? err.message : err));
  } finally {
    setTimeout(()=> popup.close(), 900);
  }
}

// ---------- initialization ----------
async function initApp(){
  await loadReferenceLibrary(700); // try to load external referenceLibrary.js
  document.getElementById('rulesList').innerHTML = buildRulesList();
  // wire up UI events
  analyzeBtn.addEventListener('click', analyzeText);
  clearBtn.addEventListener('click', ()=>{ inputEl.value=''; renderedText.innerHTML=''; barsWrap.innerHTML=''; overallPctEl.textContent='0%'; gaugeArc.style.strokeDashoffset = 290; summaryHeadline.textContent='No analysis yet'; summaryText.textContent='Click Analyze to get results.'; diagWrap.innerHTML=''; });
  downloadLogBtn.addEventListener('click', downloadLog);
  clearLocalBtn.addEventListener('click', clearLocalLogConfirmed);
  exportPdfBtn.addEventListener('click', exportPDF);
  // show initial rules list (weights)
  document.getElementById('rulesList').innerHTML = buildRulesList();
}

// start
initApp();

</script>
</body>
</html>
