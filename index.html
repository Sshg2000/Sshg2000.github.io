<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI/ Human chunked detector — hover-overlay mode</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --accent:#1e40af; --muted:#475569;
    --ai:#ef4444; --human:#10b981; --amb:#f59e0b;
    --tooltip-bg:#ffffff; --tooltip-border:#c7d2fe;
    --highlight-weak:#fff8dc; --highlight-med:#ffeed8; --highlight-strong:#ffe5ec;
  }
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--bg); color:#0b1220;}
  .wrap{max-width:1100px; margin:24px auto; padding:18px;}
  h1{margin:0 0 6px; font-size:20px;}
  .lead{color:var(--muted); margin:6px 0 14px;}
  .grid{display:grid; grid-template-columns:1fr 420px; gap:16px;}
  .card{background:var(--card); border-radius:10px; padding:14px; box-shadow:0 6px 20px rgba(13,30,60,0.06);}
  textarea{width:100%; min-height:200px; padding:10px; border-radius:8px; border:1px solid #e6eef8; font-size:14px; line-height:1.6; resize:vertical;}
  .controls{display:flex; gap:8px; align-items:center; margin-bottom:10px;}
  button{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#eef2ff; color:var(--accent); border:1px solid #dbeafe;}
  .small{font-size:13px;color:var(--muted);}
  .chunks{margin-top:12px;}
  .chunk-container{position:relative; margin-bottom:12px; transition:transform .15s ease;}
  .chunk{padding:10px;border-radius:8px; background:transparent; line-height:1.6; cursor:text;}
  .chunk.ai-strong{background:linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02));}
  .chunk.human-strong{background:linear-gradient(90deg, rgba(16,185,129,0.06), rgba(16,185,129,0.02));}
  .chunk.ambig{background:linear-gradient(90deg, rgba(245,158,11,0.04), rgba(245,158,11,0.01));}
  .label-gap{height:0; transition:height .15s ease;}
  .label-above{
    position:relative;
    display:block;
    margin-bottom:6px;
    pointer-events:none;
    opacity:0;
    transform:translateY(-6px);
    transition:opacity .12s ease, transform .12s ease;
    font-size:13px;
  }
  .label-pill{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:var(--tooltip-bg);
    border:1px solid var(--tooltip-border);
    box-shadow:0 6px 18px rgba(15,23,42,0.06);
    pointer-events:auto;
  }
  .label-pill .score{font-weight:700; margin-right:8px;}
  .signals{display:inline-block; margin-left:8px; color:var(--muted); font-size:12px;}
  /* tooltip bubble shown above */
  .tooltip{
    position:absolute;
    left:8px;
    top:-44px;
    min-width:220px;
    max-width:640px;
    background:#fff;
    border:1px solid #e6eef8;
    border-radius:8px;
    padding:10px;
    box-shadow:0 10px 30px rgba(2,6,23,0.08);
    opacity:0;
    transform:translateY(-6px);
    transition:opacity .12s ease, transform .12s ease;
    z-index:30;
    font-size:13px;
    pointer-events:none;
  }
  .tooltip .title{font-weight:700; margin-bottom:6px;}
  .tooltip .evidence{color:var(--muted); font-size:12px;}
  .chunk-container:hover .tooltip{opacity:1; transform:translateY(0); pointer-events:auto;}
  .chunk-container:hover .label-above{opacity:1; transform:translateY(0);}
  /* pointer cursor for labelled text spans */
  .match{cursor:pointer;}
  /* right column styles */
  .gauge{display:flex; align-items:center; gap:12px;}
  .bars{margin-top:12px;}
  .bar{display:flex; gap:10px; align-items:center; margin:8px 0;}
  .bar .meta{width:170px; font-size:13px; color:var(--muted);}
  .bar .meter{flex:1; height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden;}
  .bar .meter > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),#60a5fa); width:0%;}
  .bar .score{width:44px; text-align:right; font-weight:700;}
  .modes{display:flex; gap:8px; margin-top:8px; align-items:center;}
  .mode-btn{padding:6px 10px; border-radius:8px; border:1px solid #e6eef8; background:#fff; cursor:pointer;}
  .mode-btn.active{border-color:var(--accent); box-shadow:0 6px 18px rgba(30,64,175,0.06);}
  .footer{margin-top:12px; font-size:13px; color:var(--muted);}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .tooltip{left:0; right:0;} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>AI & Human chunk detector — Hover overlay mode</h1>
    <div class="lead">Chunks (paragraphs) are analyzed independently. Hover a paragraph — the line above will move up to show the scores and top signals.</div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <button id="analyzeBtn">Analyze</button>
          <button class="secondary" id="clearBtn">Clear</button>
          <button class="secondary" id="downloadLogBtn">Download Log</button>
          <button id="exportPdfBtn" style="margin-left:auto;background:#0ea5a4">Export PDF</button>
        </div>

        <textarea id="inputText" placeholder="Paste your text here..."></textarea>

        <div style="margin-top:10px" class="small">Chunking: paragraph-level. Toggle chunk granularity is planned. Hover a paragraph to inspect its label.</div>

        <div class="chunks" id="chunksContainer" aria-live="polite" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700">Config & Summary</div>
          <div class="small">Mode + calibration</div>
        </div>

        <div class="modes" style="margin-top:12px;">
          <div class="mode-btn active" data-mode="default">Default</div>
          <div class="mode-btn" data-mode="scholarly">Scholarly</div>
          <div class="mode-btn" data-mode="creative">Creative</div>
        </div>

        <div style="margin-top:12px">
          <label><input type="checkbox" id="backendToggle"> Save to backend if I consent</label>
          <input id="backendUrl" placeholder="Backend endpoint (optional)" style="width:100%;margin-top:8px;padding:6px;border-radius:6px;border:1px solid #e6eef8" value="https://your-api-endpoint.example.com/log"/>
        </div>

        <div style="margin-top:12px">
          <div class="gauge">
            <svg width="90" height="90" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="46" stroke="#eef2f6" stroke-width="14" fill="none"></circle>
              <circle id="gaugeArc" cx="60" cy="60" r="46" stroke="url(#g1)" stroke-width="14" stroke-linecap="round" stroke-dasharray="290" stroke-dashoffset="290" fill="none"></circle>
              <defs><linearGradient id="g1" x1="0%" x2="100%"><stop offset="0%" stop-color="#1e40af"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs>
            </svg>
            <div style="display:flex; flex-direction:column;">
              <div id="overallPct" style="font-weight:800;font-size:18px">0%</div>
              <div class="small">Avg AI (triggered chunks)</div>
            </div>
          </div>
        </div>

        <div id="summaryText" class="small" style="margin-top:8px">No analysis yet.</div>

        <div class="bars" id="barsWrap" style="margin-top:12px"></div>

        <div class="footer">Chunks with strong human signals show green; AI-leaning chunks show red. Hover to inspect evidence. Data is stored locally unless you consent to backend save.</div>
      </div>
    </div>
  </div>

<!-- external libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/*
  AI/Human chunk detector (hover overlay, paragraph chunks)
  - Attempts to load referenceLibrary.js (optional) to override calibration.
  - Non-diluting scoring by chunk.
  - Human-evidence negative signals included.
  - Scholarly/Creative modes adjust weights subtly.
  - Local log + optional backend POST with graceful fallback.
*/

// --- fallback reference (will be replaced if referenceLibrary.js present) ---
const FALLBACK_REFERENCE = {
  baseWeights: {
    emDash: 1.8, promo: 1.5, symbolism: 1.4, weasel: 1.2, templating: 1.3,
    disclaimer:1.0, genericSummary:1.0, phenomenon:1.1, weirdQuotes:0.5, longLists:0.8,
    hedging:0.9, citationTokens:1.2, sectionCase:0.6, emphasisSignposting:1.0,
    technicalPhrases:1.1, conjunctiveIng:0.7, overcitation:1.0, lists:0.6
  },
  stats: {
    emDash: {aiAvg:5.8, humanAvg:1.3}, promo:{aiAvg:9.2, humanAvg:2.6},
    symbolism:{aiAvg:4.0, humanAvg:1.6}, weasel:{aiAvg:3.6, humanAvg:1.5},
    templating:{aiAvg:1.9, humanAvg:0.1}, disclaimer:{aiAvg:2.2, humanAvg:0.4},
    genericSummary:{aiAvg:6.0, humanAvg:2.3}, phenomenon:{aiAvg:4.8, humanAvg:1.8},
    weirdQuotes:{aiAvg:1.1, humanAvg:0.8}, longLists:{aiAvg:6.5, humanAvg:3.2},
    hedging:{aiAvg:7.4, humanAvg:4.0}, citationTokens:{aiAvg:2.8, humanAvg:0.6},
    sectionCase:{aiAvg:3.0, humanAvg:2.6}, emphasisSignposting:{aiAvg:5.5, humanAvg:2.0},
    technicalPhrases:{aiAvg:4.2, humanAvg:3.1}, conjunctiveIng:{aiAvg:6.2, humanAvg:3.9},
    overcitation:{aiAvg:3.2, humanAvg:1.7}, lists:{aiAvg:5.0, humanAvg:2.9}
  },
  // humanSignals reduce AI-likelihood; weights >0 mean stronger human evidence
  humanSignals: {
    specificDateRange: 3.0,
    specificArtifactOrNamed: 2.5,
    nonClicheInterpretation: 2.5,
    comparativeCivilization: 3.0,
    concreteConstraint: 2.0
  }
};
let REFERENCE = window.REFERENCE_LIBRARY || FALLBACK_REFERENCE;

// Try to load optional external referenceLibrary.js if it's present
(function tryLoadReference(){
  if(window.REFERENCE_LIBRARY){ REFERENCE = window.REFERENCE_LIBRARY; return; }
  const s = document.createElement('script'); s.src='./referenceLibrary.js'; s.async=true;
  s.onload = () => { if(window.REFERENCE_LIBRARY) REFERENCE = window.REFERENCE_LIBRARY; };
  s.onerror = ()=>{/* silent fallback */};
  document.head.appendChild(s);
})();

// --- RULES (patterns) ---
const RULES = [
  { id:'emDash', label:'Em-dash overuse', weightKey:'emDash', patterns:["—{1,}"], strongIf:1, description:"Frequent em dashes / clause-chaining." },
  { id:'promo', label:'Promotional / grandeur', weightKey:'promo', patterns:["\\b(revolutionary|groundbreaking|stunning|rich tapestry|remarkable journeys?)\\b"], strongIf:1, description:"Hyperbolic or promotional adjectives." },
  { id:'symbolism', label:'Symbolic phrasing', weightKey:'symbolism', patterns:["\\b(serves as a testament|stands as a testament|serves as a reminder)\\b"], strongIf:1, description:"Rhetorical symbolism." },
  { id:'weasel', label:'Vague attributions', weightKey:'weasel', patterns:["\\b(experts say|studies suggest|research indicates|some critics argue)\\b"], strongIf:1, description:"Vague attribution without specifics." },
  { id:'templating', label:'Template placeholders', weightKey:'templating', patterns:["\\[.*?\\]","\\{\\{.*?\\}\\}"], strongIf:1, description:"Leftover templates / tokens." },
  { id:'disclaimer', label:'Model-style disclaimers', weightKey:'disclaimer', patterns:["as an AI language model","as a large language model","I\\'?m sorry,? I can\\'?t"], strongIf:1, description:"Model meta-statements." },
  { id:'genericSummary', label:'Formulaic conclusions', weightKey:'genericSummary', patterns:["\\b(in conclusion|in summary|to summarize|ultimately)\\b"], strongIf:1, description:"Formulaic concluding phrasing." },
  { id:'phenomenon', label:'Sweeping cause-effect', weightKey:'phenomenon', patterns:["\\b(is profoundly altering|is reshaping|is reshaping the availability)\\b"], strongIf:1, description:"Broad sweeping causal phrasing." },
  { id:'weirdQuotes', label:'Curly/smart quotes', weightKey:'weirdQuotes', patterns:["[\\u201c\\u201d\\u2018\\u2019]"], strongIf:2, description:"Smart quotes or typographic artifacts." },
  { id:'longLists', label:'Rule-of-three / triads', weightKey:'longLists', patterns:["\\b(\\w+[, ]+\\w+[, ]+and\\s+\\w+)\\b"], strongIf:3, description:"A, B, and C list patterns." },
  { id:'hedging', label:'Hedging words', weightKey:'hedging', patterns:["\\b(may|might|could|likely|approximately|arguably)\\b"], strongIf:2, description:"Excessive hedging." },
  { id:'citationTokens', label:'Citation-like tokens', weightKey:'citationTokens', patterns:["doi=10\\.","pmid=\\d{1,7}","access-date=\\d{4}-xx-xx"], strongIf:1, description:"Citation tokens or placeholders." },
  { id:'sectionCase', label:'Title-case headings', weightKey:'sectionCase', patterns:["^\\s*[A-Z][a-z]+(?:\\s+[A-Z][a-z]+){1,5}\\s*$"], strongIf:3, description:"Likely autogenerated section headings." },
  { id:'emphasisSignposting', label:'Signposting', weightKey:'emphasisSignposting', patterns:["\\b(it is important to note|it is crucial|it is worth noting)\\b"], strongIf:1, description:"Didactic signposting." },
  { id:'technicalPhrases', label:'Scientific terms', weightKey:'technicalPhrases', patterns:["\\b(phenological mismatch|photoperiod|breeding grounds|migration timing|stopover points)\\b"], strongIf:1, description:"Scientific-looking terminology." },
  { id:'conjunctiveIng', label:'-ing connectors', weightKey:'conjunctiveIng', patterns:["\\b(ensuring|highlighting|underscoring|contributing to|resulting in|leading to)\\b"], strongIf:2, description:"Frequent '-ing' connectors." },
  { id:'overcitation', label:'Parenthetical specifics', weightKey:'overcitation', patterns:["\\(Ficedula hypoleuca\\)|\\(Tachycineta bicolor\\)|\\(Turdus migratorius\\)","\\b(e\\.g\\.|for example|such as the)\\b"], strongIf:1, description:"Precise parenthetical examples." },
  { id:'lists', label:'Inline list headers', weightKey:'lists', patterns:["^\\s*\\d+\\.\\s+[^\\n]+:\\s","^\\s*\\-\\s+[^\\n]+:\\s","^\\s*•\\s+[^\\n]+:\\s"], strongIf:1, description:"List headers." }
];
// compile regexes
RULES.forEach(r => r.re = r.patterns.map(p => { try { return new RegExp(p, 'gmi'); } catch(e){ return new RegExp(escapeRegExp(p), 'gmi'); }}));

// --- human-evidence detectors (pattern-based) ---
const HUMAN_PATTERNS = [
  { id:'specificDateRange', label:'Specific date range', pattern:/\b\d{3,4}\s*(?:BCE|BC|CE|AD)?\s*(?:to|–|-)\s*\d{3,4}\s*(?:BCE|BC|CE|AD)?\b/i },
  { id:'specificArtifactOrNamed', label:'Specific named artifact/person', pattern:/\b(Scarab|Scarab Amulet|Nile|Mandate of Heaven|pharaoh|Old Kingdom|Indus River Valley)\b/i },
  { id:'nonClicheInterpretation', label:'Interpretive analysis', pattern:/\b(believed to|were believed to|interpreted as|symbol of|represented|associated with)\b/i },
  { id:'comparativeCivilization', label:'Civilization comparison', pattern:/\b(similar to the|like the Mandate of Heaven|comparable to)\b/i },
  { id:'concreteConstraint', label:'Concrete migration constraint', pattern:/\b(desert|river level|migration would be|too great a challenge|unable to do so)\b/i }
];

// UI refs
const inputEl = document.getElementById('inputText');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadLogBtn = document.getElementById('downloadLogBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const backendToggle = document.getElementById('backendToggle');
const backendUrlInput = document.getElementById('backendUrl');
const chunksContainer = document.getElementById('chunksContainer');
const barsWrap = document.getElementById('barsWrap');
const overallPctEl = document.getElementById('overallPct');
const summaryText = document.getElementById('summaryText');
const modeBtns = document.querySelectorAll('.mode-btn');

const LOG_KEY = 'ai_detector_chunk_log_v1';

// helpers
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function getLocalLog(){ try{ const raw = localStorage.getItem(LOG_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function appendLocalLog(entry){ try{ const arr = getLocalLog(); arr.push(entry); localStorage.setItem(LOG_KEY, JSON.stringify(arr)); } catch(e){ console.warn('save log failed', e); } }
function downloadLog(){ const arr = getLocalLog(); const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ai_detector_chunk_log.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

// effective weight with mode tweaks
let CURRENT_MODE = 'default';
function effectiveWeight(key){
  const baseW = (REFERENCE.baseWeights && (REFERENCE.baseWeights[key] !== undefined)) ? REFERENCE.baseWeights[key] : 1.0;
  const stat = (REFERENCE.stats && REFERENCE.stats[key]) ? REFERENCE.stats[key] : {aiAvg:1, humanAvg:1};
  let eff = baseW * (stat.aiAvg / Math.max(1, stat.humanAvg));
  // mode adjustments: scholarly reduces penalty for technical phrases (makes human signals stronger)
  if(CURRENT_MODE === 'scholarly'){
    if(key === 'technicalPhrases') eff *= 0.8;
    if(key === 'emDash') eff *= 0.95;
  } else if(CURRENT_MODE === 'creative'){
    // creative mode: increase weight on promotional / stylistic cues
    if(key === 'promo' || key === 'symbolism') eff *= 1.15;
  }
  return eff;
}

// analyze a single chunk (text)
function analyzeChunk(text){
  const result = {text, matches:[], counts:{}, localScores:{}, aiScore:0, humanScore:0};
  // initialize counts
  RULES.forEach(r=>result.counts[r.id]=0);
  // find matches for each rule
  RULES.forEach(r=>{
    r.re.forEach(rx=>{
      rx.lastIndex = 0;
      let m;
      while((m = rx.exec(text)) !== null){
        result.counts[r.id] += 1;
        result.matches.push({rule:r.id, text:m[0]});
        if(m.index === rx.lastIndex) rx.lastIndex++;
      }
    });
  });
  // compute local s_i (0-100)
  const triggered = [];
  RULES.forEach(r=>{
    const cnt = result.counts[r.id] || 0;
    const local = Math.min(100, Math.round((cnt / (r.strongIf || 1)) * 25));
    result.localScores[r.id] = local;
    if(local>0) triggered.push({id:r.id,local, weightEff: effectiveWeight(r.weightKey)});
  });
  // AI score: weighted average across triggered rules only (non-diluting)
  let wSum=0, ws=0;
  triggered.forEach(t=>{ ws += t.local * t.weightEff; wSum += t.weightEff; });
  result.aiScore = wSum ? Math.round(ws / wSum) : 0;
  // compute humanScore based on human patterns presence
  let humanRaw=0;
  HUMAN_PATTERNS.forEach(h=>{
    if(h.pattern.test(text)) humanRaw += (REFERENCE.humanSignals && REFERENCE.humanSignals[h.id]) ? REFERENCE.humanSignals[h.id] : 2.0;
  });
  // scale humanRaw into 0-100 (arbitrary mapping but consistent)
  result.humanScore = Math.min(100, Math.round((humanRaw / 10) * 100));
  // compute final combined "lean" for convenience: we will display both aiScore and humanScore separately
  // collect top signals for display
  const signalCounts = {};
  result.matches.forEach(m=> signalCounts[m.rule] = (signalCounts[m.rule]||0)+1 );
  result.topSignals = Object.entries(signalCounts).sort((a,b)=>b[1]-a[1]).slice(0,4).map(e=>({rule:e[0],count:e[1]}));
  return result;
}

// chunk text into paragraphs (strip empties)
function chunkTextIntoParagraphs(text){
  // normalize newlines
  const paras = text.split(/\n{1,}/).map(p=>p.trim()).filter(p=>p.length>0);
  return paras;
}

// render chunks to DOM
function renderChunks(results){
  chunksContainer.innerHTML = '';
  results.forEach((res, idx)=>{
    const cont = document.createElement('div'); cont.className='chunk-container';
    // label gap (the DOM element that will "move" above)
    const labelGap = document.createElement('div'); labelGap.className='label-gap';
    const labelAbove = document.createElement('div'); labelAbove.className='label-above';
    const pill = document.createElement('span'); pill.className='label-pill';
    // prepare colors
    const isAI = res.aiScore > res.humanScore + 10; // AI-leaning
    const isHuman = res.humanScore > res.aiScore + 10;
    const ambig = !isAI && !isHuman;
    // pill content: both scores
    pill.innerHTML = `<span class="score" style="color:${isAI? 'var(--ai)': (isHuman? 'var(--human)': 'var(--amb)')}">
                        AI ${res.aiScore}%</span>
                      <span class="score" style="color:${isHuman? 'var(--human)':'var(--muted)'}">
                        Human ${res.humanScore}%</span>
                      <span class="signals">· ${res.topSignals.map(s=>escapeHtml(s.rule)).join(', ')}</span>`;
    labelAbove.appendChild(pill);
    // chunk element with main text
    const chunkEl = document.createElement('div');
    chunkEl.className = 'chunk ' + (isAI? 'ai-strong': (isHuman? 'human-strong':'ambig'));
    chunkEl.innerHTML = escapeHtml(res.text);
    // tooltip bubble
    const tooltip = document.createElement('div'); tooltip.className='tooltip';
    tooltip.innerHTML = `<div class="title">${isAI? 'AI-leaning chunk' : (isHuman? 'Human-leaning chunk' : 'Mixed / ambiguous chunk')}</div>
      <div><strong>AI score:</strong> ${res.aiScore}% &nbsp; <strong>Human score:</strong> ${res.humanScore}%</div>
      <div style="margin-top:8px" class="evidence"><strong>Top signals:</strong> ${res.topSignals.map(s=>escapeHtml(s.rule + (s.count>1? ' x'+s.count:''))).join(', ')}</div>`;
    // append pieces
    cont.appendChild(labelAbove);
    cont.appendChild(tooltip);
    cont.appendChild(chunkEl);
    chunksContainer.appendChild(cont);

    // hover handlers: make the line above move up to create a gap and show label
    cont.addEventListener('mouseenter', ()=>{
      // show label gap visually by moving this container down (so previous line appears to move up)
      // We'll move the previous sibling up if exists
      const prev = cont.previousElementSibling;
      if(prev && prev.classList.contains('chunk-container')){
        prev.style.transform = 'translateY(-28px)';
      }
      // also enlarge label gap (by setting height)
      labelGap.style.height = '10px';
      labelAbove.style.opacity = '1';
      labelAbove.style.transform = 'translateY(0)';
      tooltip.style.opacity = '1';
      tooltip.style.transform = 'translateY(0)';
    });
    cont.addEventListener('mouseleave', ()=>{
      const prev = cont.previousElementSibling;
      if(prev && prev.classList.contains('chunk-container')) prev.style.transform = '';
      labelGap.style.height = '0';
      labelAbove.style.opacity = '0';
      labelAbove.style.transform = 'translateY(-6px)';
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(-6px)';
    });
  });
}

// aggregate summary (average AI across chunks that triggered) and bars
function renderSummary(chunkResults){
  // compute avg AI across chunks that had nonzero ai or human signals (we'll average aiScore)
  const triggered = chunkResults.filter(c => c.aiScore>0 || c.humanScore>0);
  const avgAI = triggered.length ? Math.round(triggered.reduce((s,c)=>s+c.aiScore,0)/triggered.length) : 0;
  overallPctEl.textContent = avgAI + '%';
  const dash = 290 - (290 * (avgAI/100));
  const arc = document.getElementById('gaugeArc');
  if(arc) arc.style.strokeDashoffset = dash;
  summaryText.textContent = `Avg AI score across ${triggered.length} chunk(s).`;
  // simple bars for top rules (global)
  const globalCounts = {};
  chunkResults.forEach(c=> c.topSignals.forEach(s=> globalCounts[s.rule] = (globalCounts[s.rule]||0)+s.count));
  const entries = Object.entries(globalCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  barsWrap.innerHTML = entries.map(e=> {
    const label = e[0], cnt=e[1], pct = Math.min(100, Math.round((cnt/5)*20));
    return `<div class="bar"><div class="meta">${escapeHtml(label)}</div><div class="meter"><i style="width:${pct}%"></i></div><div class="score">${pct}%</div></div>`;
  }).join('');
}

// main analyze flow
function analyzeAll(){
  const text = inputEl.value || '';
  if(!text.trim()){ alert('Paste text first'); return; }
  const paras = chunkTextIntoParagraphs(text);
  const results = paras.map(p => analyzeChunk(p));
  renderChunks(results);
  renderSummary(results);

  // store audit log entry
  const entry = {
    ts: new Date().toISOString(),
    mode: CURRENT_MODE,
    results: results.map(r=>({ai:r.aiScore, human:r.humanScore, topSignals:r.topSignals.slice(0,3), snippet:r.text.slice(0,300)}))
  };
  appendLocalLog(entry);

  // backend post if consented (graceful fallback)
  if(backendToggle.checked){
    const url = (backendUrlInput.value || '').trim();
    if(!url){ alert('Please enter a backend URL'); return; }
    if(!confirm('Send the analysis to backend? You consent to POST the anonymized entry.')) return;
    fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry)})
      .then(resp => {
        if(!resp.ok) throw new Error('Server: '+resp.status);
        alert('Saved to backend successfully.');
      })
      .catch(err => {
        console.warn('backend save failed', err);
        alert('Could not send to server; analysis stored locally instead.');
      });
  }
}

// export PDF: renders the visible annotated chunks into a clean report popup and saves
async function exportPDF(){
  // build a minimal report HTML with annotated chunks
  const parasHtml = Array.from(document.querySelectorAll('.chunk-container')).map(cont=>{
    const pill = cont.querySelector('.label-pill') ? cont.querySelector('.label-pill').outerHTML : '';
    const chunkHtml = cont.querySelector('.chunk') ? cont.querySelector('.chunk').innerHTML : '';
    const tooltipText = cont.querySelector('.tooltip') ? cont.querySelector('.tooltip').innerHTML : '';
    return `<div style="margin-bottom:14px">${pill}<div style="padding:10px;border-radius:6px;background:#fff;margin-top:6px">${chunkHtml}</div><div style="color:#6b7280;font-size:12px;margin-top:6px">${tooltipText}</div></div>`;
  }).join('');
  const report = `<div style="font-family:Arial,Helvetica,sans-serif;padding:24px;color:#0b1220">
      <h1>AI/Human chunk analysis</h1>
      <div style="margin-bottom:8px">Generated: ${new Date().toISOString()}</div>
      ${parasHtml}
      <div style="margin-top:20px;color:#6b7280;font-size:12px">Heuristics only — not proof of authorship.</div>
    </div>`;
  const popup = window.open('', '_blank', 'width=900,height=1000');
  if(!popup){ alert('Popup blocked; allow popups to export PDF.'); return; }
  popup.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Report</title></head><body style="margin:0;padding:0;background:#f6f8fb">${report}</body></html>`);
  await new Promise(res => setTimeout(res, 400));
  try{
    const canvas = await html2canvas(popup.document.body, {scale:1.4, backgroundColor:null, useCORS:true});
    const img = canvas.toDataURL('image/jpeg', 0.94);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
    pdf.addImage(img, 'JPEG', 0, 0, canvas.width, canvas.height);
    pdf.save('ai_chunk_report.pdf');
  } catch(e){
    alert('Export failed: '+ (e && e.message ? e.message : e));
  } finally {
    setTimeout(()=> popup.close(), 900);
  }
}

// UI wiring
analyzeBtn.addEventListener('click', analyzeAll);
clearBtn.addEventListener('click', ()=>{ inputEl.value=''; chunksContainer.innerHTML=''; barsWrap.innerHTML=''; overallPctEl.textContent='0%'; summaryText.textContent='No analysis yet.'; });
downloadLogBtn.addEventListener('click', downloadLog);
exportPdfBtn.addEventListener('click', exportPDF);
modeBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    modeBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    CURRENT_MODE = btn.dataset.mode;
  });
});

// preload sample essay if page loaded blank
if(!inputEl.value.trim()){
  inputEl.value = `The Impact of Climate Change on Bird Migration
Introduction

For centuries, the seasonal migrations of birds have fascinated naturalists and scientists alike. Each year, millions of birds embark on remarkable journeys that span continents and oceans, guided by an intricate interplay of instinct, environmental cues, and evolutionary adaptation. Migration serves as a crucial mechanism that allows birds to exploit varying ecological conditions—breeding in temperate regions during summer and retreating to warmer climates during winter. This ancient rhythm of movement has been finely balanced for millennia. However, in the modern age, this delicate equilibrium faces unprecedented disruption. Climate change—an all-encompassing transformation of global weather patterns driven largely by human activity—is profoundly altering the world’s ecosystems. Among its many consequences, the impact on avian migration stands out as both scientifically significant and ecologically alarming.`;
}

</script>
</body>
</html>
