<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI vs Human Detector — Calibrated & Explainable</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --accent:#1e40af; --muted:#6b7280;
    --weak:#fffbe6; --med:#fff0e6; --strong:#ffeef4; --danger:#cc0000;
    --human:#ecfdf5;
  }
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:var(--bg); color:#0b1230;}
  .wrap{max-width:1180px; margin:26px auto; padding:20px;}
  h1{margin:0 0 6px; font-size:20px;}
  .lead{color:var(--muted); margin:8px 0 18px;}
  .grid{display:grid; grid-template-columns:1fr 420px; gap:18px;}
  .card{background:var(--card); border-radius:10px; padding:14px; box-shadow:0 8px 26px rgba(13,30,60,0.06);}
  textarea{width:100%; min-height:420px; padding:12px; border-radius:8px; border:1px solid #e6eef8; font-size:14px; line-height:1.6; resize:vertical; background:transparent;}
  .controls{display:flex; gap:8px; align-items:center; margin-bottom:10px;}
  button{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#eef2ff; color:var(--accent); border:1px solid #dbeafe;}
  .small{font-size:13px;color:var(--muted);}
  .gauge{display:flex; align-items:center; gap:12px;}
  .bars{margin-top:10px;}
  .bar{display:flex; gap:10px; align-items:center; margin:8px 0;}
  .bar .meta{width:170px; font-size:13px; color:var(--muted);}
  .bar .meter{flex:1; height:12px; background:#f1f5f9; border-radius:999px; overflow:hidden;}
  .bar .meter > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),#60a5fa); width:0%;}
  .bar .score{width:44px; text-align:right; font-weight:700;}
  .highlights{margin-top:12px; padding:12px; border-radius:8px; border:1px dashed #e6eef8; background:#fff;}
  /* highlight style B - color + thin underline */
  .match{background:transparent; padding:0 2px; text-decoration:underline; text-decoration-style:dashed; text-decoration-thickness:1px; text-underline-offset:4px; cursor:pointer;}
  .match.ai{background:linear-gradient(90deg, rgba(255,244,200,0.6), rgba(255,244,200,0.2));}
  .match.med{background:linear-gradient(90deg, rgba(255,225,200,0.6), rgba(255,225,200,0.2));}
  .match.strong{background:linear-gradient(90deg, rgba(255,230,240,0.6), rgba(255,230,240,0.2));}
  .match.human{background:linear-gradient(90deg, rgba(220,255,235,0.6), rgba(220,255,235,0.2)); text-decoration-color: #059669;}
  .explain{font-size:13px;color:var(--muted); margin-top:8px;}
  .diag{padding:12px;border-radius:8px;margin-top:10px}
  .diag.emdash{background:#ffecef;border:2px solid var(--danger); box-shadow:0 6px 18px rgba(204,0,0,0.06)}
  .diag.ai{background:#fff7e6;border:1px solid #ffd08a}
  .diag.human{background:var(--human);border:1px solid #8ef1be}
  .footer{margin-top:12px; font-size:13px; color:var(--muted);}
  .inspector{border-left:1px solid #eef2f6; padding-left:12px;}
  .rule-row{padding:8px;border-radius:6px;margin-bottom:8px;background:#fff}
  .rule-row:hover{box-shadow:0 6px 18px rgba(13,30,60,0.06)}
  .meta-row{font-size:13px;color:var(--muted);margin-top:6px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .gauge{margin-top:12px} .inspector{border-left:none;padding-left:0} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>AI vs Human Detector — Explainable & Calibrated</h1>
    <div class="lead">This page calculates both AI and Human signals and shows a relative AI likelihood. Hover highlighted phrases to see the match details in the Match Inspector (right panel). No browser tooltip flicker — inspector is stable.</div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <button id="analyzeBtn">Analyze</button>
          <button class="secondary" id="clearBtn">Clear</button>
          <button id="downloadLogBtn" class="secondary">Download Log</button>
          <button id="exportPdfBtn" style="margin-left:auto;background:#0ea5a4">Export PDF</button>
        </div>

        <textarea id="inputText" placeholder="Paste the text you want to analyze..."></textarea>

        <div class="explain">
          <details open>
            <summary><strong>How scores are computed</strong></summary>
            <div style="margin-top:8px">
              <div><strong>Plain:</strong> we compute an AI signal score and a Human signal score (separate rule sets). The final AI likelihood is AI / (AI + Human). Only categories that appear (nonzero) are used, so missing categories don't dilute the result.</div>
              <div style="margin-top:6px"><strong>Formula:</strong> <code>AI_likelihood = AI_total / (AI_total + Human_total)</code></div>
            </div>
          </details>
          <div style="margin-top:8px">
            <label><input type="checkbox" id="backendToggle"> Save to backend if I consent</label>
            <input id="backendUrl" placeholder="Backend endpoint URL (optional)" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e6eef8;margin-left:8px" value="https://your-api-endpoint.example.com/log"/>
          </div>
          <div style="margin-top:8px" class="small">Results stored locally by default; click Download Log to export all stored analyses.</div>
        </div>

        <div class="highlights" aria-live="polite">
          <div style="font-weight:700;margin-bottom:8px">Highlighted text (click or hover fragments to inspect)</div>
          <div id="renderedText" style="white-space:pre-wrap; font-size:15px; line-height:1.6;"></div>
        </div>
      </div>

      <div class="card inspector">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Match Inspector & Results</div>
          <div class="small">AI vs Human (relative)</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:12px; align-items:center;">
          <div class="gauge">
            <svg width="110" height="110" viewBox="0 0 120 120">
              <defs><linearGradient id="g1" x1="0%" x2="100%"><stop offset="0%" stop-color="#1e40af"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs>
              <circle cx="60" cy="60" r="46" stroke="#eef2f6" stroke-width="14" fill="none"></circle>
              <circle id="gaugeArc" cx="60" cy="60" r="46" stroke="url(#g1)" stroke-width="14" stroke-linecap="round" stroke-dasharray="290" stroke-dashoffset="290" fill="none"></circle>
            </svg>
            <div style="display:flex;flex-direction:column;align-items:center;">
              <div id="overallPct" style="font-weight:800;font-size:20px">0%</div>
              <div class="small" id="verdictText">No analysis yet</div>
            </div>
          </div>

          <div style="flex:1">
            <div id="summaryHeadline" style="font-weight:700">No analysis yet</div>
            <div id="summaryText" class="small">Run analysis to see AI vs Human signals.</div>
            <div id="weightsList" style="margin-top:10px; max-height:220px; overflow:auto;" class="small"></div>
          </div>
        </div>

        <div class="bars" id="barsWrap"></div>

        <div style="margin-top:12px; font-weight:700">Inspector</div>
        <div id="inspectorPane" style="margin-top:8px; max-height:300px; overflow:auto;">
          <div class="small">Hover a highlighted span in the text to view match details here. Click a match to pin it.</div>
        </div>

        <div id="diagWrap"></div>

        <div class="footer">Heuristic tool for research. Not definitive proof.</div>
      </div>
    </div>
  </div>

<!-- html2canvas and jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* Single-file AI vs Human Detector
   - Tries to read window.REFERENCE_LIBRARY if you add a referenceLibrary.js in same folder (optional).
   - If not present, uses embedded reference calibration.
   - Dual rule sets: AI and Human. Each rule has patterns, base weight key matching REFERENCE.baseWeights keys.
   - Scoring:
       local = min(100, round((count / strongIf) * 30))
       total = sum(local * effectiveWeight)
     AI_likelihood = round(100 * AI_total / (AI_total + Human_total))
   - Cluster amplification: if AI matches are dense (matches per 100 words high) AI_total is scaled up a bit.
   - Highlights use underline+dashed style; hover shows details in inspector pane (no browser title tooltips).
*/

// ---------- Embedded fallback reference ----------
const FALLBACK_REFERENCE = {
  baseWeights: {
    emDash:1.9, promo:1.6, symbolism:1.5, weasel:1.3, templating:1.4,
    disclaimer:1.1, genericSummary:1.0, phenomenon:1.2, weirdQuotes:0.5, longLists:0.8,
    hedging:0.9, citationTokens:1.3, sectionCase:0.6, emphasisSignposting:1.0,
    technicalPhrases:1.1, conjunctiveIng:0.8, overcitation:1.1, lists:0.6
  },
  stats: {
    emDash:{aiAvg:5.8,humanAvg:1.1}, promo:{aiAvg:8.8,humanAvg:3.4},
    symbolism:{aiAvg:4.0,humanAvg:1.5}, weasel:{aiAvg:3.6,humanAvg:1.4},
    templating:{aiAvg:1.9,humanAvg:0.1}, disclaimer:{aiAvg:2.2,humanAvg:0.4},
    genericSummary:{aiAvg:6.0,humanAvg:2.3}, phenomenon:{aiAvg:4.8,humanAvg:1.8},
    weirdQuotes:{aiAvg:1.1,humanAvg:0.8}, longLists:{aiAvg:6.5,humanAvg:3.2},
    hedging:{aiAvg:7.4,humanAvg:4.0}, citationTokens:{aiAvg:2.8,humanAvg:0.6},
    sectionCase:{aiAvg:3.0,humanAvg:2.6}, emphasisSignposting:{aiAvg:5.5,humanAvg:2.0},
    technicalPhrases:{aiAvg:4.2,humanAvg:3.1}, conjunctiveIng:{aiAvg:6.2,humanAvg:3.9},
    overcitation:{aiAvg:3.2,humanAvg:1.7}, lists:{aiAvg:5.0,humanAvg:2.9}
  }
};

const REFERENCE = window.REFERENCE_LIBRARY || FALLBACK_REFERENCE;

// ---------- Rule sets ----------
const RULES_AI = [
  {id:'emDash', label:'Em-dash overuse', key:'emDash', patterns:["—{1,}"], strongIf:1, desc:"Frequent em dashes indicate clause chaining typical of many generated essays."},
  {id:'promo', label:'Promotional language', key:'promo', patterns:["\\b(revolutionary|groundbreaking|stunning|thriving|boasts a|rich tapestry|remarkable journeys?)\\b","\\b(remarkable|extraordinary|unprecedented|profoundly)\\b"], strongIf:1, desc:"Generic hyperbole and grand adjectives."},
  {id:'symbolism', label:'Symbolic phrasing', key:'symbolism', patterns:["\\b(serves as a testament|serves as a reminder|stands as a testament|stands as)\\b"], strongIf:1, desc:"Rhetorical symbolism and signposting."},
  {id:'weasel', label:'Vague attributions', key:'weasel', patterns:["\\b(experts say|some critics argue|observers have noted|studies suggest|research indicates|it is argued)\\b"], strongIf:1, desc:"Attributions without specific sources."},
  {
  id:'templating',
  label:'Template tokens',
  key:'templating',
  // only catch full placeholders like [NAME], [INSERT], not [ed]
  patterns:[
    "\\[\\s*(insert|name|title|summary|description|text|here|INPUT|TODO|TBD|REPLACE)[^\\]]*\\]",
    "\\{\\{.*?\\}\\}",
    "Enter\\s+\\w+"
  ],
  strongIf:1,
  desc:"Leftover template placeholders (not literary editorial brackets)."
},
  {id:'genericSummary', label:'Formulaic summaries', key:'genericSummary', patterns:["\\b(in conclusion|in summary|to summarize|ultimately|what was once)\\b"], strongIf:1, desc:"Formulaic section endings."},
  {id:'phenomenon', label:'Sweeping cause-effect phrases', key:'phenomenon', patterns:["\\b(is profoundly altering|is reshaping|is reshaping the availability|profoundly altering)\\b"], strongIf:1, desc:"Broad-scope causal language."},
  {id:'longLists', label:'Rule-of-three triads', key:'longLists', patterns:["\\b(\\w+\\s*,\\s*\\w+\\s*,\\s*and\\s*\\w+)\\b"], strongIf:3, desc:"'A, B, and C' polished list constructions."},
  {id:'citationTokens', label:'Citation-like tokens', key:'citationTokens', patterns:["doi=10\\.","pmid=\\d{1,7}","access-date=\\d{4}-xx-xx","2025-xx-xx"], strongIf:1, desc:"Placeholder or synthetic citation strings."},
  {id:'technicalPhrases', label:'Scientific-sounding terms', key:'technicalPhrases', patterns:["\\b(phenological mismatch|photoperiod|breeding grounds|migration timing|stopover points)\\b"], strongIf:1, desc:"Domain terms used generically."},
  {id:'conjunctiveIng', label:'-ing connectors', key:'conjunctiveIng', patterns:["\\b(ensuring|highlighting|underscoring|contributing to|resulting in|leading to)\\b"], strongIf:2, desc:"Frequent present-participle linking."}
];

const RULES_HUMAN = [
  {id:'contractions', label:'Conversational contractions', key:'human1', patterns:["\\b(ain't|gonna|wanna|can't believe|don't think)\\b"], strongIf:1, desc:"Conversational contractions and colloquial speech."},
  {id:'idiosyncratic', label:'Idiosyncratic phrasing / idioms', key:'human2', patterns:["\\b(you can tell|to be honest|the thing is|oddly enough|I remember when)\\b"], strongIf:1, desc:"Personal idioms and narrative cues."},
  {id:'disfluency', label:'Disfluencies & fillers', key:'human3', patterns:["\\b(um,|uh,|well,|you know,|like,)\\b"], strongIf:1, desc:"Hesitations and filler words common in human writing."},
  {id:'shortsent', label:'Short sentence fragments', key:'human4', patterns:["(^|[\\.\\?\\!]\\s+)[A-Z][a-z]{0,10}\\s+[a-z]+[\\.\\?\\!\\n]"], strongIf:2, desc:"Short fragment sentences and abrupt turns."},
  {id:'punctuation_variance', label:'Punctuation variance', key:'human5', patterns:["[\\.]{3,}|\\;{1}|\\!{2,}"], strongIf:2, desc:"Ellipses, semicolons, repeated exclamation — varied punctuation."},
  {id:'nometa', label:'Absence of meta-statements', key:'human6', patterns:["\\b(I|me|we|my|our)\\b"], strongIf:2, desc:"Personal pronouns used naturally (not always AI-like)."}
  {id:'editorialBrackets', label:'Editorial bracket edits', key:'human6', patterns:["\\w+\\[[a-z]{1,4}\\]"], strongIf:1, desc:"Bracketed edits inside words (literary notation)." },

];

// compile regex
RULES_AI.forEach(r => r.re = r.patterns.map(p => safeRe(p)));
RULES_HUMAN.forEach(r => r.re = r.patterns.map(p => safeRe(p)));

function safeRe(p){ try{return new RegExp(p,'gmi');}catch(e){ return new RegExp(escapeRegExp(p),'gmi'); } }
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ---------- UI elements ----------
const inputEl = document.getElementById('inputText');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadLogBtn = document.getElementById('downloadLogBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const backendToggle = document.getElementById('backendToggle');
const backendUrlInput = document.getElementById('backendUrl');

const renderedText = document.getElementById('renderedText');
const barsWrap = document.getElementById('barsWrap');
const overallPctEl = document.getElementById('overallPct');
const gaugeArc = document.getElementById('gaugeArc');
const summaryHeadline = document.getElementById('summaryHeadline');
const summaryText = document.getElementById('summaryText');
const weightsList = document.getElementById('weightsList');
const inspectorPane = document.getElementById('inspectorPane');
const diagWrap = document.getElementById('diagWrap');

analyzeBtn.addEventListener('click', analyze);
clearBtn.addEventListener('click', ()=>{ inputEl.value=''; clearAll(); });
downloadLogBtn.addEventListener('click', downloadLog);
exportPdfBtn.addEventListener('click', exportPDF);

// preload sample essay (your bird migration essay)
inputEl.value = `The Impact of Climate Change on Bird Migration
Introduction

For centuries, the seasonal migrations of birds have fascinated naturalists and scientists alike. Each year, millions of birds embark on remarkable journeys that span continents and oceans, guided by an intricate interplay of instinct, environmental cues, and evolutionary adaptation. Migration serves as a crucial mechanism that allows birds to exploit varying ecological conditions—breeding in temperate regions during summer and retreating to warmer climates during winter. This ancient rhythm of movement has been finely balanced for millennia. However, in the modern age, this delicate equilibrium faces unprecedented disruption. Climate change—an all-encompassing transformation of global weather patterns driven largely by human activity—is profoundly altering the world’s ecosystems. Among its many consequences, the impact on avian migration stands out as both scientifically significant and ecologically alarming.

As global temperatures rise, precipitation patterns shift, and ecosystems are restructured, migratory birds face increasing challenges in timing, navigation, and survival. Changes in climate are reshaping the availability of resources, altering migration routes, and disrupting the synchrony between birds and the seasonal cycles on which they depend. This essay explores the multifaceted impact of climate change on bird migration, focusing on alterations in migration timing, routes, breeding success, and overall population dynamics.

Changing Environmental Cues

Bird migration depends heavily on environmental cues such as temperature, photoperiod (day length), and food availability. These natural signals inform birds when to depart, which direction to travel, and when to return. Yet climate change is distorting these cues, making them increasingly unreliable.

In many regions, spring temperatures are rising earlier than in previous decades. This causes some bird species to begin their migrations prematurely, arriving at breeding grounds before the peak abundance of food resources. In contrast, other species—whose migration timing is more strongly governed by photoperiod—may fail to adjust, arriving too late to take advantage of optimal conditions. This phenomenon, known as a phenological mismatch, can have serious consequences. For example, insectivorous birds such as the pied flycatcher (Ficedula hypoleuca) now often arrive in Europe after the peak of caterpillar abundance, leading to reduced breeding success and population declines.

Furthermore, irregular weather patterns, such as prolonged droughts, heatwaves, and unseasonal storms, can interrupt migration routes. Wetland habitats that once provided critical stopover points for rest and feeding are drying up or shifting geographically. Without these essential refueling stations, many birds struggle to complete their migrations, resulting in increased mortality and weakened populations.

Shifts in Migration Timing and Routes

One of the most well-documented effects of climate change on bird migration is the alteration in migration timing. Long-term studies have shown that numerous species now migrate earlier in the spring and later in the autumn. In North America, for instance, species such as the tree swallow (Tachycineta bicolor) and the American robin (Turdus migratorius) are arriving on their breeding grounds several days or even weeks earlier than they did in the mid-20th century. Similarly, in Europe, the barn swallow (Hirundo rustica) has advanced its spring arrival by over a week in some regions.

In addition to timing shifts, migration routes are also changing. As global temperatures rise, some species are extending their ranges northward into previously unsuitable territories. This expansion, while initially appearing adaptive, can expose birds to new ecological risks—such as unfamiliar predators, competitors, or inadequate nesting conditions. In Arctic and sub-Arctic regions, for example, melting ice and changing vegetation patterns have opened new areas for birds, but these zones are unstable and may not provide consistent resources in the long term.

Moreover, climate-induced habitat loss in tropical and subtropical regions threatens the wintering grounds of countless migratory birds. The shrinking of wetlands in Africa’s Sahel or the deforestation of South American rainforests removes vital habitats, forcing birds to travel further or settle in less suitable areas. The cumulative strain of longer migrations, unpredictable weather, and dwindling resources poses an existential threat to many species.

Ecosystem Mismatches and Breeding Success

A critical consequence of disrupted migration patterns is the growing asynchrony between birds and their ecosystems. Birds have evolved to time their breeding cycles so that their chicks hatch when food is most abundant. However, climate change has altered the timing of insect emergence, plant flowering, and fruiting seasons, decoupling the relationship between birds and their food supply.

For example, in northern Europe, warmer springs have led to earlier insect hatches, but many migratory birds arriving from Africa still follow traditional schedules. The result is that chicks are often raised during periods of food scarcity, leading to higher mortality rates and declining populations. This mismatch not only threatens individual species but can ripple through entire ecosystems. Birds play crucial roles as pollinators, seed dispersers, and pest controllers; thus, their decline can destabilize ecological networks and diminish biodiversity.

In addition, altered climates can affect the breeding success of birds directly. Extreme weather events—such as heatwaves or heavy rainfall—can destroy nests, reduce the availability of nesting materials, and stress adult birds during crucial reproductive stages. High temperatures may also reduce egg viability or chick survival, further exacerbating population declines.

Adaptive Responses and Conservation Challenges

Despite these challenges, some species exhibit a degree of plasticity—the ability to adjust behaviorally or physiologically to changing conditions. Short-distance migrants, which rely more on local environmental cues than long-distance signals, have shown greater capacity to modify their migration schedules. However, long-distance migrants, such as those traveling between continents, are less able to adapt quickly because their movements are tightly controlled by innate genetic programs rather than flexible environmental feedback.

Conservationists are increasingly emphasizing adaptive management strategies to mitigate these threats. Protecting and restoring critical habitats along migration routes, creating wildlife corridors, and monitoring population trends are essential steps. International cooperation is also vital, as migratory birds cross multiple political boundaries during their journeys. Agreements such as the Convention on the Conservation of Migratory Species of Wild Animals (CMS) and regional initiatives like Natura 2000 in Europe aim to provide a coordinated approach to safeguarding migratory species.

Moreover, reducing greenhouse gas emissions remains the most fundamental solution. Unless the rate of climate change is slowed, even the most well-designed conservation measures may not suffice to preserve the complex migratory systems that birds depend upon.

Conclusion

The impact of climate change on bird migration is both profound and far-reaching. It affects not only when and where birds travel but also their survival, reproduction, and ecological roles within their environments. What was once a predictable and harmonious natural cycle is now increasingly erratic, reflecting the instability of the planet’s changing climate.

Bird migration serves as a powerful indicator of environmental health. The disruptions observed among migratory species are not isolated events but symptoms of a broader ecological imbalance. The future of these birds—and the ecosystems they sustain—depends on humanity’s ability to address the root causes of climate change, to conserve vital habitats, and to foster resilience in natural systems.

Ultimately, the story of migrating birds is also the story of the planet itself: interconnected, delicate, and vulnerable to our collective actions. Protecting these travelers of the sky is not merely an act of compassion—it is an imperative step toward preserving the balance of life on Earth.`;

// ---------- helpers ----------
function safeExecRegex(regex, text){
  try{
    regex.lastIndex = 0;
    return regex.exec(text);
  } catch(e){ return null; }
}
function countMatches(regex, text){
  let c = 0, m;
  try{
    regex.lastIndex = 0;
    while((m = regex.exec(text)) !== null){
      c++; if(m.index === regex.lastIndex) regex.lastIndex++;
    }
  }catch(e){}
  return c;
}
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// ---------- effective weight ----------
function effectiveWeight(key){
  const base = REFERENCE.baseWeights && REFERENCE.baseWeights[key] ? REFERENCE.baseWeights[key] : 1.0;
  const stat = REFERENCE.stats && REFERENCE.stats[key] ? REFERENCE.stats[key] : {aiAvg:1, humanAvg:1};
  return base * (stat.aiAvg / Math.max(1, stat.humanAvg));
}

// ---------- analyze ----------
function analyze(){
  const text = inputEl.value || '';
  if(!text.trim()){ alert('Paste some text to analyze'); return; }

  // find AI matches
  const aiMatches = [];
  const aiCounts = {};
  RULES_AI.forEach(r => aiCounts[r.id]=0);
  RULES_AI.forEach(r => {
    r.re.forEach(rx => {
      let m; rx.lastIndex = 0;
      while((m = rx.exec(text)) !== null){
        aiCounts[r.id]++; aiMatches.push({start:m.index,end:m.index+m[0].length,text:m[0],rule:r}); if(m.index === rx.lastIndex) rx.lastIndex++;
      }
    });
  });

  // find Human matches
  const humanMatches = [];
  const humanCounts = {};
  RULES_HUMAN.forEach(r => humanCounts[r.id]=0);
  RULES_HUMAN.forEach(r => {
    r.re.forEach(rx => {
      let m; rx.lastIndex = 0;
      while((m = rx.exec(text)) !== null){
        humanCounts[r.id]++; humanMatches.push({start:m.index,end:m.index+m[0].length,text:m[0],rule:r}); if(m.index === rx.lastIndex) rx.lastIndex++;
      }
    });
  });

  // compute local scores
  const perAI = [];
  RULES_AI.forEach(r => {
    const cnt = aiCounts[r.id] || 0;
    const local = Math.min(100, Math.round((cnt / (r.strongIf || 1)) * 30));
    if(local > 0){
      perAI.push({id:r.id,label:r.label,count:cnt,local,weightEff:effectiveWeight(r.key),desc:r.desc,rule:r});
    }
  });
  const perHuman = [];
  RULES_HUMAN.forEach(r => {
    const cnt = humanCounts[r.id] || 0;
    const local = Math.min(100, Math.round((cnt / (r.strongIf || 1)) * 30));
    if(local > 0){
      perHuman.push({id:r.id,label:r.label,count:cnt,local,weightEff: (r.key in REFERENCE.baseWeights ? effectiveWeight(r.key) : 1.0),desc:r.desc,rule:r});
    }
  });

  // Weighted totals
  let aiTotal = perAI.reduce((s,p)=> s + p.local * p.weightEff, 0);
  let humanTotal = perHuman.reduce((s,p)=> s + p.local * p.weightEff, 0);

  // cluster amplification for AI: matches per 100 words
  const words = (text.trim().split(/\s+/).length || 1);
  const aiDensity = aiMatches.length / (words / 100);
  // amplify modestly: +0%..+40% (so large densities significantly boost AI_total)
  const amp = Math.min(0.4, aiDensity * 0.04);
  if(aiMatches.length > 0) aiTotal = Math.round(aiTotal * (1 + amp));

  // compute normalized AI likelihood (human weighted x2)
  const sum = aiTotal + (5 * humanTotal);
  const aiLikelihood = sum > 0 ? Math.round(100 * (aiTotal / sum)) : 0;

  // prepare highlights: combine all matches, avoid overlap by priority (AI first) then human
  const combined = [];
  aiMatches.forEach(m=> combined.push({...m,source:'AI'}));
  humanMatches.forEach(m=> combined.push({...m,source:'Human'}));
  combined.sort((a,b)=> a.start - b.start || b.end - a.end);

  // remove overlaps: pick earlier + longer
  const finalMatches = [];
  let cursor = 0;
  for(const m of combined){
    if(m.end <= cursor) continue;
    // if overlaps with last, skip if lower priority (we keep AI over Human when overlapping)
    if(finalMatches.length){
      const last = finalMatches[finalMatches.length-1];
      if(m.start < last.end){
        // overlap: decide priority: keep AI if any is AI and last is Human
        if(last.source === 'Human' && m.source === 'AI'){
          // replace last with m if m covers more
          if(m.end >= last.end){ finalMatches[finalMatches.length-1] = m; cursor = m.end; continue; } else { continue; }
        } else { continue; }
      }
    }
    finalMatches.push(m); cursor = m.end;
  }

  // build highlighted HTML
  let out = '', pos = 0;
  for(const m of finalMatches){
    out += escapeHtml(text.slice(pos, m.start));
    // choose classes: ai/med/strong or human
    let cls = 'match';
    const cntForRule = (m.source === 'AI') ? aiCounts[m.rule.id] : humanCounts[m.rule.id];
    const weightEff = (m.source==='AI') ? effectiveWeight(m.rule.key) : (m.rule.key in REFERENCE.baseWeights ? effectiveWeight(m.rule.key) : 1.0);
    if(m.source === 'Human') cls += ' human';
    else{
      if(cntForRule >= (m.rule.strongIf || 1) * 3 || weightEff >= 1.6) cls += ' strong ai';
      else if(cntForRule >= (m.rule.strongIf || 1) * 2 || weightEff >= 1.2) cls += ' med ai';
      else cls += ' ai';
    }
    // create span with data-index so inspector can reference (no title attr)
    const index = finalMatches.indexOf(m);
    out += `<span class="${cls}" data-source="${m.source}" data-ruleid="${m.rule.id}" data-index="${index}">${escapeHtml(m.text)}</span>`;
    pos = m.end;
  }
  out += escapeHtml(text.slice(pos));
  renderedText.innerHTML = out || '(no matches)';

  // attach hover / click handlers to spans (inspector shows details)
  const spans = renderedText.querySelectorAll('span.match');
  spans.forEach(s=>{
    s.addEventListener('mouseenter', onSpanHover);
    s.addEventListener('mouseleave', onSpanLeave);
    s.addEventListener('click', onSpanClick);
  });

  // render bars (show both AI and Human top categories)
  barsWrap.innerHTML = '';
  // combine perAI and perHuman into display table sorted by contribution (local*weight)
  const contributions = [];
  perAI.forEach(p => contributions.push({type:'AI',score:p.local * p.weightEff, label:p.label, local:p.local, count:p.count}));
  perHuman.forEach(p => contributions.push({type:'Human',score:p.local * p.weightEff, label:p.label, local:p.local, count:p.count}));
  contributions.sort((a,b)=>b.score - a.score);
  contributions.slice(0,12).forEach(c=>{
    const div = document.createElement('div'); div.className='bar';
    const pct = Math.min(100, Math.round(c.local));
    div.innerHTML = `<div class="meta">${escapeHtml(c.label)} <span style="font-size:12px;color:${c.type==='AI'?'#c2410c':'#059669'}"> (${c.type})</span></div>
      <div class="meter"><i style="width:${pct}%"></i></div>
      <div class="score">${pct}%</div>`;
    barsWrap.appendChild(div);
  });

  // update gauge & summary
  overallPctEl.textContent = aiLikelihood + '%';
  const dash = 290 - (290 * (aiLikelihood/100));
  gaugeArc.style.strokeDashoffset = dash;
  summaryHeadline.textContent = aiLikelihood >= 75 ? 'AI-leaning (strong)' : (aiLikelihood >= 45 ? 'Mixed (uncertain)' : 'Human-leaning');
  summaryText.textContent = `AI ${aiTotal} vs Human ${humanTotal} — ${aiLikelihood}% AI likelihood (relative)`;

  // weights list
  weightsList.innerHTML = buildWeightsList();

  // diagnostic cards
  diagWrap.innerHTML = '';
  // show AI high reliability cards for top AI matches first (emDash special styling)
  perAI.slice(0,6).forEach(rp=>{
    const el = document.createElement('div'); el.className = rp.id==='emDash' ? 'diag emdash' : 'diag ai';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(rp.label)} — ${rp.local}% (${rp.count} matches)</div>
                    <div class="small" style="margin-top:8px">${escapeHtml(rp.desc)}</div>
                    <div class="small" style="margin-top:8px">Effective weight: ${rp.weightEff.toFixed(2)}</div>`;
    diagWrap.appendChild(el);
  });
  perHuman.slice(0,6).forEach(rp=>{
    const el = document.createElement('div'); el.className = 'diag human';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(rp.label)} — ${rp.local}% (${rp.count} matches)</div>
                    <div class="small" style="margin-top:8px">${escapeHtml(rp.desc)}</div>`;
    diagWrap.appendChild(el);
  });

  // store audit log entry
  const entry = {
    timestamp: new Date().toISOString(),
    aiLikelihood, aiTotal, humanTotal,
    perAI: perAI.map(p=>({id:p.id,label:p.label,local:p.local,count:p.count,weightEff:p.weightEff})),
    perHuman: perHuman.map(p=>({id:p.id,label:p.label,local:p.local,count:p.count,weightEff:p.weightEff})),
    snippet: text.slice(0,2000)
  };
  appendLocalLog(entry);

  // optional backend post
  if(backendToggle.checked){
    const url = backendUrlInput.value && backendUrlInput.value.trim();
    if(url){
      if(confirm('Send this analysis to the configured backend endpoint?')){
        fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry)})
          .then(res=> res.ok ? alert('Saved to backend.') : alert('Server returned ' + res.status))
          .catch(err=> alert('Failed to post to backend: ' + (err && err.message ? err.message : err)));
      }
    } else alert('Please set a backend URL if you want to send analyses.');
  }

  // helper: inspector initial info
  inspectorPane.innerHTML = `<div class="small">Found ${aiMatches.length} AI-like matches and ${humanMatches.length} human-like matches. Hover a highlighted fragment to see details here.</div>`;
}

// ---------- inspector interactions ----------
let pinned = null;

function onSpanHover(e){
  const s = e.currentTarget;
  if(pinned) return;
  showInspectorForSpan(s);
}
function onSpanLeave(e){
  if(pinned) return;
  inspectorPane.innerHTML = `<div class="small">Hover a highlighted fragment to see details here. Click to pin.</div>`;
}
function onSpanClick(e){
  const s = e.currentTarget;
  if(pinned === s){ pinned = null; inspectorPane.innerHTML = `<div class="small">Inspector unpinned. Hover to inspect other fragments.</div>`; return; }
  pinned = s;
  showInspectorForSpan(s);
}

function showInspectorForSpan(span){
  const ruleId = span.getAttribute('data-ruleid');
  const source = span.getAttribute('data-source');
  const text = span.textContent;
  // find rule metadata
  let rule = null;
  if(source === 'AI') rule = RULES_AI.find(r=>r.id === ruleId);
  else rule = RULES_HUMAN.find(r=>r.id === ruleId);
  const label = rule ? rule.label : ruleId;
  const desc = rule ? rule.desc : 'Matched pattern';
  const sourceColor = source==='AI' ? '#c2410c' : '#059669';
  // strength heuristics (based on class)
  const cls = span.className;
  const strength = cls.includes('strong') ? 'High' : cls.includes('med') ? 'Medium' : 'Low';
  inspectorPane.innerHTML = `
    <div style="padding:8px;border-radius:8px;background:#fff" class="rule-row">
      <div style="font-weight:700">${escapeHtml(label)} <span style="color:${sourceColor};font-weight:700">(${escapeHtml(source)})</span></div>
      <div class="meta-row"><strong>Matched text:</strong> <span style="color:#0b1220">${escapeHtml(text)}</span></div>
      <div class="meta-row"><strong>Interpretation:</strong> ${escapeHtml(desc)}</div>
      <div class="meta-row"><strong>Strength:</strong> ${strength}</div>
      <div class="meta-row" style="margin-top:6px"><button id="insCopyBtn" class="secondary">Copy match</button></div>
    </div>
  `;
  const copyBtn = inspectorPane.querySelector('#insCopyBtn');
  if(copyBtn) copyBtn.addEventListener('click', ()=> {
    navigator.clipboard && navigator.clipboard.writeText(text).then(()=> alert('Copied match to clipboard.'));
  });
}

// ---------- local log ----------
const LOG_KEY = 'ai_detector_log_v2';
function getLocalLog(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY) || '[]'); }catch(e){return [];} }
function appendLocalLog(entry){ const arr = getLocalLog(); arr.push(entry); try{ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }catch(e){console.warn('could not save log',e);} }
function downloadLog(){ const arr = getLocalLog(); const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='ai_detector_log.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function clearAll(){ renderedText.innerHTML=''; barsWrap.innerHTML=''; overallPctEl.textContent='0%'; gaugeArc.style.strokeDashoffset=290; summaryHeadline.textContent='No analysis yet'; summaryText.textContent=''; inspectorPane.innerHTML=''; diagWrap.innerHTML=''; weightsList.innerHTML = buildWeightsList(); }

// ---------- build weights list ----------
function buildWeightsList(){
  let html = '<div><strong>Calibrated effective weights</strong></div><div style="font-size:13px;margin-top:8px">';
  const keys = Object.keys(REFERENCE.baseWeights || {});
  keys.forEach(k=>{
    const base = REFERENCE.baseWeights[k] || 1.0;
    const stat = REFERENCE.stats && REFERENCE.stats[k] ? REFERENCE.stats[k] : {aiAvg:1,humanAvg:1};
    const eff = Math.round(base * (stat.aiAvg / Math.max(1,stat.humanAvg)) * 100)/100;
    html += `<div style="margin-bottom:6px"><strong>${escapeHtml(k)}</strong> base ${base} → effective ${eff}</div>`;
  });
  html += '</div>';
  return html;
}
weightsList.innerHTML = buildWeightsList();

// ---------- PDF export ----------
async function exportPDF(){
  const title = 'ai_detector_report';
  const overall = overallPctEl.textContent || '0%';
  const headline = summaryHeadline.textContent || '';
  const reportHtml = `
    <div style="font-family:Arial,Helvetica,sans-serif;padding:24px;color:#101828">
      <h1>AI-detection report</h1>
      <div style="margin-bottom:8px"><strong>Overall AI likelihood:</strong> ${escapeHtml(overall)} — ${escapeHtml(headline)}</div>
      <div style="margin-bottom:8px"><strong>Scoring:</strong> AI_likelihood = AI_total / (AI_total + Human_total). Only triggered categories are used.</div>
      <h3>Inspector & Diagnostics</h3>
      <div>${document.getElementById('inspectorPane').innerHTML}</div>
      <h3 style="margin-top:12px">Highlighted text</h3>
      <div style="padding:12px;border:1px solid #eef2f6;border-radius:8px;background:#fff;white-space:pre-wrap">${renderedText.innerHTML}</div>
      <div style="margin-top:18px;color:#6b7280;font-size:12px">Heuristic tool — not definitive proof.</div>
    </div>
  `;
  const popup = window.open('','_blank','width=800,height=1000');
  if(!popup){ alert('Popup blocked. Allow popups to export PDF.'); return; }
  popup.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Report</title></head><body style="margin:0;padding:0;background:#f6f7fb">${reportHtml}</body></html>`);
  await new Promise(r=>setTimeout(r,350));
  try{
    const canvas = await html2canvas(popup.document.body, {scale:1.4, backgroundColor:null, useCORS:true});
    const imgData = canvas.toDataURL('image/jpeg', 0.94);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
    pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
    pdf.save(title + '.pdf');
  }catch(err){ alert('Export failed: ' + (err && err.message ? err.message : err)); }
  finally{ setTimeout(()=> popup.close(),900); }
}

// initialize
weightsList.innerHTML = buildWeightsList();
inspectorPane.innerHTML = `<div class="small">Hover highlighted fragments to inspect matches here. Click to pin.</div>`;

</script>
</body>
</html>
